{"version":3,"file":"initinfobox.min.js","sources":["../src/initinfobox.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/.\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * @package mod\r\n * @subpackage organizer\r\n * @copyright 2020 Thomas Niedermaier (thomas.niedermaier@gmail.com)\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * Tab appointments view and students view: Load slot list according to view options stored in user prefs.\r\n */\r\n\r\n\r\ndefine(['jquery', 'core/config'], function($, config) {\r\n\r\n        /**\r\n     * @constructor\r\n     * @alias module:mod_organizer/initinfobox\r\n     */\r\n        var Initinfobox = function() {\r\n            this.student = 0;\r\n            this.userid = 0;\r\n        };\r\n\r\n        var instance = new Initinfobox();\r\n\r\n        instance.init = function(participant, userid) {\r\n\r\n            instance.student = participant; // Is user student or not?\r\n            instance.userid = userid; // This user ID.\r\n\r\n            // What happens when a view option checkbox is clicked or the filter field has been changed.\r\n            function toggle_all_slots(event) {\r\n                if (event!=undefined) {\r\n                    saveuserpreference();\r\n                }\r\n                var tablebody = $('#slot_overview tbody');\r\n                var showpastslots = $('#show_past_slots').is(':checked');\r\n                var showmyslotsonly = $('#show_my_slots_only').is(':checked');\r\n                var showfreeslotsonly = $('#show_free_slots_only').is(':checked');\r\n                var showhiddenslots = $('#show_hidden_slots').is(':checked');\r\n                var showregistrationsonly = $('#show_registrations_only').is(':checked');\r\n\r\n                tablebody.find('tr').show();\r\n\r\n                if (showregistrationsonly) {\r\n                    tablebody.find('tr.not_registered').hide();\r\n                }\r\n\r\n                if (!instance.student) {\r\n                    if (!showhiddenslots) {\r\n                        tablebody.find('tr.unavailable').hide();\r\n                    }\r\n                }\r\n\r\n                if (!showpastslots) {\r\n                    tablebody.find('tr.past_due').hide();\r\n                }\r\n\r\n                if (showmyslotsonly) {\r\n                    if (!instance.student) {\r\n                        tablebody.find('tr.not_my_slot').hide();\r\n                    }\r\n                }\r\n\r\n                if (showfreeslotsonly) {\r\n                    tablebody.find('tr.not_free_slot').hide();\r\n                }\r\n\r\n                var target = $('.organizer_filtertable');\r\n                if (target) {\r\n                    var filter = target.val().toUpperCase();\r\n                    if (filter) {\r\n                        var tr = tablebody.find('tr:visible:not(.info)');\r\n                        // Loop through all table rows, and hide those who don't match the search query.\r\n                        var i, j, td, text, found;\r\n                        for (i = 0; i < tr.length; i++) {\r\n                            found = false;\r\n                            td = tr[i].getElementsByTagName(\"td\");\r\n                            if (td) {\r\n                                for (j = 0; j < td.length; j++) {\r\n                                    text = extracttext(td[j]);\r\n                                    if (text) {\r\n                                        if (text.toUpperCase().indexOf(filter) > -1) {\r\n                                            found = true;\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                            if (!found) {\r\n                                $(tr[i]).hide();\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                tablebody.show();\r\n\r\n                toggle_info();\r\n            }\r\n\r\n            function toggle_info() {\r\n                var tablebody = $('#slot_overview tbody');\r\n                var noninforows = tablebody.find('tr:not(.info)');\r\n                var noneexist = noninforows.length === 0;\r\n                var anyvisible = false;\r\n\r\n                noninforows.each(\r\n                    function() {\r\n                        if ($(this).css('display') !== 'none') {\r\n                            anyvisible = true;\r\n                        }\r\n                    }\r\n                );\r\n\r\n                var showpastslots = $('#show_past_slots').is(':checked');\r\n                var showmyslotsonly = $('#show_my_slots_only').is(':checked');\r\n\r\n                tablebody.find('tr.info').hide();\r\n                if (!anyvisible) {\r\n                    if (noneexist) {\r\n                        tablebody.find('tr.no_slots_defined').show();\r\n                    } else if (showpastslots && !showmyslotsonly) {\r\n                        tablebody.find('tr.no_slots').show();\r\n                    } else if (showpastslots && showmyslotsonly) {\r\n                        tablebody.find('tr.no_my_slots').show();\r\n                    } else {\r\n                        tablebody.find('tr.no_due_slots').show();\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Extract visible text from 'element' down thru DOM tree.\r\n            function extracttext(element) {\r\n                var text, last, img;\r\n\r\n                last = $(element).clone().find(\"script,style\").remove().end();\r\n                text = last.text();\r\n                if (!text) {\r\n                    img = last.find('img:not(.icon)').first();\r\n                    var attr = img.attr('alt');\r\n                    if (typeof attr !== typeof undefined && attr !== false) {\r\n                        text = attr;\r\n                    }\r\n                }\r\n                return text;\r\n            }\r\n\r\n            // Save userpreference to server.\r\n            function saveuserpreference() {\r\n                let slotsviewoptions = '';\r\n\r\n                slotsviewoptions += $('#show_my_slots_only').is(':checked') ? '1' : '0';\r\n                slotsviewoptions += $('#show_free_slots_only').is(':checked') ? '1' : '0';\r\n                slotsviewoptions += $('#show_hidden_slots').is(':checked') ? '1' : '0';\r\n                slotsviewoptions += $('#show_past_slots').is(':checked') ? '1' : '0';\r\n                slotsviewoptions += $('#show_registrations_only').is(':checked') ? '1' : '0';\r\n\r\n                $.get(config.wwwroot + '/mod/organizer/slotsviewoptions.php', {\r\n                    sesskey: config.sesskey,\r\n                    slotsviewoptions: encodeURI(slotsviewoptions),\r\n                    userid: instance.userid\r\n                }, 'json');\r\n\r\n            }\r\n\r\n            $('#show_past_slots').on('click', function() { toggle_all_slots(event); });\r\n            $('#show_my_slots_only').on('click', function() { toggle_all_slots(event); });\r\n            $('#show_free_slots_only').on('click', function() { toggle_all_slots(event); });\r\n            $('#show_hidden_slots').on('click', function() { toggle_all_slots(event); });\r\n            $('#show_registrations_only').on('click', function() { toggle_all_slots(event); });\r\n            $('.organizer_filtertable').on('keyup', function() { toggle_all_slots(event); });\r\n            toggle_all_slots();\r\n        };\r\n\r\n        return instance;\r\n\r\n    }\r\n);\r\n"],"names":["define","$","config","instance","this","student","userid","init","participant","toggle_all_slots","event","slotsviewoptions","undefined","is","get","wwwroot","sesskey","encodeURI","tablebody","showpastslots","showmyslotsonly","showfreeslotsonly","showhiddenslots","showregistrationsonly","find","show","hide","target","filter","val","toUpperCase","i","j","td","text","found","tr","length","getElementsByTagName","extracttext","indexOf","noninforows","noneexist","anyvisible","each","css","toggle_info","element","last","clone","remove","end","attr","first","_typeof","on"],"mappings":"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"}